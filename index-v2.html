<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MapToPoster</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #0a0a0a;
      --bg2: #141414;
      --bg3: #1e1e1e;
      --card: #161616;
      --border: #2a2a2a;
      --text: #e5e5e5;
      --text2: #888;
      --text3: #555;
      --accent: #4a9eff;
      --radius: 12px;
    }
    
    [data-ui="classic"] {
      --bg: #e8e4dc;
      --bg2: #f0ece4;
      --bg3: #f8f6f1;
      --card: #fff;
      --border: #d4cfc4;
      --text: #2c2416;
      --text2: #5a5347;
      --text3: #8a8478;
      --accent: #2d7a54;
    }
    
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    
    /* === THREE COLUMN LAYOUT === */
    .app {
      display: grid;
      grid-template-columns: 240px 1fr 260px;
      grid-template-rows: auto 1fr;
      height: 100vh;
      gap: 0;
    }
    
    /* === HEADER === */
    .header {
      grid-column: 1 / -1;
      padding: 12px 20px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 14px;
      font-weight: 300;
      letter-spacing: 4px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .theme-toggle {
      display: flex;
      background: var(--bg3);
      border-radius: 8px;
      padding: 3px;
      border: 1px solid var(--border);
    }
    .theme-toggle button {
      padding: 6px 12px;
      border: none;
      background: transparent;
      color: var(--text3);
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    .theme-toggle button.active { background: var(--accent); color: #fff; }
    .theme-toggle button:hover:not(.active) { color: var(--text); }
    
    /* === LEFT COLUMN: CITIES === */
    .col-cities {
      background: var(--bg2);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .col-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    .col-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--text3);
      font-weight: 600;
    }
    .city-search {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .city-search input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
    }
    .city-search input:focus { outline: none; border-color: var(--accent); }
    .city-search input::placeholder { color: var(--text3); }
    .city-filters {
      display: flex;
      gap: 6px;
    }
    .city-filters select {
      flex: 1;
      padding: 7px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text2);
      font-size: 11px;
      cursor: pointer;
    }
    .city-count {
      padding: 0 16px 8px;
      font-size: 11px;
      color: var(--text3);
    }
    .city-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 8px 8px;
    }
    .city-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 2px;
    }
    .city-item:hover { background: var(--bg3); }
    .city-item.active { background: var(--accent); }
    .city-item .name { font-size: 13px; font-weight: 500; }
    .city-item .country { font-size: 11px; color: var(--text3); margin-top: 1px; }
    .city-item.active .name { color: #fff; }
    .city-item.active .country { color: rgba(255,255,255,0.7); }
    
    /* === CENTER: PREVIEW === */
    .col-preview {
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 20px;
    }
    #preview {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      cursor: grab;
    }
    #preview:active { cursor: grabbing; }
    .zoom-controls {
      position: absolute;
      top: 16px;
      right: 16px;
      display: none;
      align-items: center;
      gap: 4px;
      background: var(--card);
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .zoom-controls.visible { display: flex; }
    .zoom-controls button {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--bg3);
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .zoom-controls button:hover { background: var(--accent); color: #fff; }
    .zoom-controls span {
      font-size: 11px;
      color: var(--text2);
      min-width: 45px;
      text-align: center;
    }
    .status-bar {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--text2);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-bar.loading { color: var(--accent); }
    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .progress {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--border);
      display: none;
    }
    .progress.active { display: block; }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #6ab0ff);
      width: 0%;
      transition: width 0.3s;
    }
    
    /* === RIGHT COLUMN: OPTIONS === */
    .col-options {
      background: var(--bg2);
      border-left: 1px solid var(--border);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }
    
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
    }
    .card-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text3);
      margin-bottom: 10px;
      font-weight: 600;
    }
    .card select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
    }
    .card select:focus { outline: none; border-color: var(--accent); }
    .card input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
    }
    .card input:focus { outline: none; border-color: var(--accent); }
    .card input::placeholder { color: var(--text3); }
    
    /* Pill Toggle */
    .pill-toggle {
      display: flex;
      background: var(--bg);
      border-radius: 8px;
      padding: 4px;
      border: 1px solid var(--border);
    }
    .pill-toggle input { display: none; }
    .pill-toggle label {
      flex: 1;
      padding: 8px 12px;
      text-align: center;
      font-size: 12px;
      color: var(--text2);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .pill-toggle input:checked + label {
      background: var(--accent);
      color: #fff;
    }
    
    .card-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .btn {
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover { background: #3d8ce8; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary {
      background: var(--bg3);
      color: var(--text2);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover:not(:disabled) { background: var(--bg); color: var(--text); }
    .btn-secondary:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-row {
      display: flex;
      gap: 8px;
    }
    .btn-row .btn { flex: 1; }
    
    /* Checkbox */
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text2);
      cursor: pointer;
    }
    .checkbox-row input { width: 16px; height: 16px; accent-color: var(--accent); }
    
    /* Slider */
    .slider-row {
      margin-top: 4px;
    }
    .slider-row .slider-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text2);
      margin-bottom: 6px;
    }
    .slider-row input[type="range"] {
      width: 100%;
      height: 4px;
      -webkit-appearance: none;
      background: var(--border);
      border-radius: 2px;
      outline: none;
    }
    .slider-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }
    
    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal.open { display: flex; }
    .modal-content {
      background: var(--bg2);
      border-radius: 16px;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      width: 100%;
      border: 1px solid var(--border);
    }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 2px;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--text2);
      font-size: 24px;
      cursor: pointer;
    }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 20px; }
    
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
    }
    .theme-card {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }
    .theme-card:hover { border-color: var(--accent); transform: translateY(-2px); }
    .theme-card canvas { width: 100%; display: block; }
    .theme-card-info { padding: 10px; display: flex; justify-content: space-between; align-items: center; }
    .theme-card-name { font-size: 12px; font-weight: 500; }
    
    /* Batch Modal */
    .batch-input {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
    }
    .batch-options { display: flex; gap: 12px; margin: 16px 0; flex-wrap: wrap; }
    .batch-options select {
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
    }
    .batch-log {
      background: var(--bg);
      border-radius: 8px;
      padding: 12px;
      font-family: monospace;
      font-size: 11px;
      max-height: 150px;
      overflow-y: auto;
      margin-top: 12px;
      color: var(--text2);
    }
    
    /* Responsive */
    @media (max-width: 1000px) {
      .app { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr auto; }
      .col-cities, .col-options { border: none; border-bottom: 1px solid var(--border); }
    }
    
    /* Hidden helpers */
    #offscreen { display: none; }
  </style>
</head>
<body data-ui="dark">
<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="logo">MAPTOPOSTER</div>
    <div class="header-right">
      <div class="theme-toggle">
        <button id="uiClassic">Classic</button>
        <button id="uiDark" class="active">Dark</button>
      </div>
    </div>
  </header>
  
  <!-- Left Column: Cities -->
  <div class="col-cities">
    <div class="col-header">
      <div class="col-title">Cities</div>
    </div>
    <div class="city-search">
      <input type="text" id="citySearch" placeholder="Search cities...">
      <div class="city-filters">
        <select id="regionFilter">
          <option value="">All Regions</option>
          <option value="North America">N. America</option>
          <option value="South America">S. America</option>
          <option value="Europe">Europe</option>
          <option value="Asia">Asia</option>
          <option value="Africa">Africa</option>
          <option value="Oceania">Oceania</option>
        </select>
        <select id="sortOrder">
          <option value="name">A → Z</option>
          <option value="name-desc">Z → A</option>
          <option value="country">Country</option>
        </select>
      </div>
    </div>
    <div class="city-count" id="cityCount">200+ cities</div>
    <div class="city-list" id="cityList"></div>
  </div>
  
  <!-- Center: Preview -->
  <div class="col-preview">
    <div class="zoom-controls" id="zoomControls">
      <button id="zoomOut">−</button>
      <span id="zoomLevel">100%</span>
      <button id="zoomIn">+</button>
      <button id="zoomReset" style="font-size:10px; width:auto; padding:0 10px;">Reset</button>
    </div>
    <canvas id="preview"></canvas>
    <div class="status-bar" id="status">Select a city to get started</div>
    <div class="progress" id="progress"><div class="progress-bar" id="progressBar"></div></div>
  </div>
  
  <!-- Right Column: Options -->
  <div class="col-options">
    <div class="card">
      <div class="card-label">Theme</div>
      <select id="theme"></select>
    </div>
    
    <div class="card">
      <div class="card-label">Orientation</div>
      <div class="pill-toggle" id="orientToggle">
        <input type="radio" name="orient" id="orientPortrait" value="portrait" checked>
        <label for="orientPortrait">Portrait</label>
        <input type="radio" name="orient" id="orientLandscape" value="landscape">
        <label for="orientLandscape">Landscape</label>
      </div>
    </div>
    
    <div class="card">
      <div class="card-label">Size</div>
      <div class="pill-toggle" id="sizeToggle">
        <input type="radio" name="size" id="size5x7" value="5x7" checked>
        <label for="size5x7">5×7"</label>
        <input type="radio" name="size" id="size8x10" value="8x10">
        <label for="size8x10">8×10"</label>
      </div>
    </div>
    
    <div class="card">
      <div class="card-label">Display Name</div>
      <input type="text" id="customCity" placeholder="Auto-detect">
    </div>
    
    <div class="card" style="margin-top:auto;">
      <div class="card-actions">
        <button class="btn btn-primary" id="generate">Generate Preview</button>
        <div class="btn-row">
          <button class="btn btn-secondary" id="download" disabled>PNG</button>
          <button class="btn btn-secondary" id="downloadSvg" disabled>SVG</button>
        </div>
        <div class="btn-row">
          <button class="btn btn-secondary" id="compare" disabled>Compare</button>
          <button class="btn btn-secondary" id="batch">Batch</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden elements for compatibility -->
<input type="text" id="customCountry" style="display:none;">
<input type="text" id="search" style="display:none;">
<div id="results" style="display:none;"></div>
<div id="selected" style="display:none;"></div>
<div id="recent" style="display:none;"></div>
<select id="fontStyle" style="display:none;"><option value="system-ui, sans-serif">Clean Sans</option></select>
<input type="checkbox" id="water" checked style="display:none;">
<input type="checkbox" id="showCoords" checked style="display:none;">
<input type="range" id="roadWeight" value="1" style="display:none;">
<span id="roadWeightVal" style="display:none;"></span>
<input type="range" id="radius" value="10000" style="display:none;">
<span id="radVal" style="display:none;"></span>
<div id="themePreview" style="display:none;"></div>
<div id="advancedCollapsible" style="display:none;"><div class="collapsible-header"></div></div>

<!-- Compare Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>COMPARE THEMES</h2>
      <button class="modal-close" id="modalClose">×</button>
    </div>
    <div class="modal-body">
      <div class="theme-grid" id="themeGrid"></div>
    </div>
  </div>
</div>

<!-- Batch Modal -->
<div class="modal" id="batchModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>BATCH MODE</h2>
      <button class="modal-close" id="batchClose">×</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:12px; color:var(--text2); font-size:13px;">Enter one city per line (e.g., "Paris, France")</p>
      <textarea class="batch-input" id="batchInput" placeholder="Paris, France&#10;Tokyo, Japan&#10;New York, USA"></textarea>
      <div class="batch-options">
        <select id="batchTheme"></select>
        <select id="batchSize">
          <option value="5x7-portrait">5×7" Portrait</option>
          <option value="5x7-landscape">5×7" Landscape</option>
          <option value="8x10-portrait">8×10" Portrait</option>
          <option value="8x10-landscape">8×10" Landscape</option>
        </select>
        <button class="btn btn-primary" id="batchStart">Start Batch</button>
      </div>
      <div class="progress" id="batchProgress"><div class="progress-bar" id="batchProgressBar"></div></div>
      <div id="batchStatus" style="font-size:12px; color:var(--text2); margin-top:8px;"></div>
      <div class="batch-log" id="batchLog"></div>
    </div>
  </div>
</div>

<canvas id="offscreen"></canvas>

<script src="cities.js"></script>
<script>
const THEMES = {
  noir: { name: "Noir", desc: "Classic dark", bg: "#0a0a0a", text: "#fff", water: "#151520", roads: ["#fff","#ccc","#999","#666","#444"] },
  parchment: { name: "Ancient Parchment", desc: "Fantasy map style", bg: "#d4c4a8", text: "#2a1f14", water: "#8b9a7d", roads: ["#2a1f14","#3d2e1f","#5a4632","#7a6652","#9a8672"] },
  hologram: { name: "Hologram", desc: "Sci-fi futuristic", bg: "#050510", text: "#0ff", water: "#001a1a", roads: ["#0ff","#0af","#08f","#06a","#035"] },
  neon: { name: "Neon City", desc: "Cyberpunk nights", bg: "#0a0012", text: "#f0f", water: "#0f0a1a", roads: ["#0ff","#f0f","#ff0","#f60","#609"] },
  comic: { name: "Comic Pop", desc: "Bold cartoon style", bg: "#fff", text: "#000", water: "#7ec8e3", roads: ["#000","#e63946","#f4a261","#2a9d8f","#264653"] },
  candy: { name: "Candy", desc: "Bright & playful", bg: "#fff5f5", text: "#d63384", water: "#a8e6cf", roads: ["#d63384","#ff6b6b","#feca57","#48dbfb","#a55eea"] },
  midnight: { name: "Midnight Blue", desc: "Deep ocean tones", bg: "#0d1b2a", text: "#e0e1dd", water: "#1b263b", roads: ["#ffd700","#e0e1dd","#778da9","#415a77","#1b263b"] },
  blueprint: { name: "Blueprint", desc: "Technical drafting", bg: "#0a2463", text: "#fff", water: "#061539", roads: ["#fff","#d4e4f7","#9db4ce","#6884a5","#3e5c76"] },
  sepia: { name: "Vintage Sepia", desc: "Old photograph", bg: "#f5f0e6", text: "#2c2c2c", water: "#d4c4a8", roads: ["#2c2c2c","#4a4a4a","#6a6a6a","#9a9a9a","#c0c0c0"] },
  forest: { name: "Enchanted Forest", desc: "Deep woodland", bg: "#0f1a0f", text: "#98d982", water: "#0a120a", roads: ["#98d982","#6ab04c","#4a8030","#2a5010","#1a3008"] },
  sunset: { name: "Sunset", desc: "Warm golden hour", bg: "#1a0a0a", text: "#ffd700", water: "#2d1f1f", roads: ["#ff6b35","#f7c59f","#efa48b","#d7816a","#bd4f6c"] },
  ice: { name: "Frozen", desc: "Arctic cold", bg: "#e8f4f8", text: "#1a3a4a", water: "#a8d4e6", roads: ["#1a3a4a","#2a5a7a","#4a8aaa","#7abacc","#aadaee"] }
};

const ROAD_TYPES = ['motorway','motorway_link','trunk','trunk_link','primary','primary_link','secondary','secondary_link','tertiary','tertiary_link','residential','living_street','unclassified'];
const SIZES = {
  '5x7': { portrait: [1500, 2100], landscape: [2100, 1500] },
  '8x10': { portrait: [2400, 3000], landscape: [3000, 2400] }
};
const BASE_WIDTHS = [2.5, 2, 1.5, 1, 0.5];

let place = null, data = null, zoom = 1, panX = 0, panY = 0, currentCity = null;

const $ = id => document.getElementById(id);

// DOM Elements
const searchEl = $('search'), resultsEl = $('results'), selectedEl = $('selected'), recentEl = $('recent');
const customCityEl = $('customCity'), customCountryEl = $('customCountry');
const themeEl = $('theme'), previewEl = $('themePreview'), waterEl = $('water'), showCoordsEl = $('showCoords');
const fontStyleEl = $('fontStyle'), roadWeightEl = $('roadWeight'), radiusEl = $('radius');
const genBtn = $('generate'), dlBtn = $('download'), dlSvgBtn = $('downloadSvg'), compareBtn = $('compare'), batchBtn = $('batch');
const statusEl = $('status'), progressEl = $('progress'), progressBar = $('progressBar');
const canvas = $('preview'), offscreen = $('offscreen');
const modal = $('modal'), modalClose = $('modalClose'), themeGrid = $('themeGrid');
const batchModal = $('batchModal'), batchClose = $('batchClose'), batchInput = $('batchInput');
const batchTheme = $('batchTheme'), batchSize = $('batchSize'), batchStart = $('batchStart');
const batchStatus = $('batchStatus'), batchProgress = $('batchProgress'), batchProgressBar = $('batchProgressBar'), batchLog = $('batchLog');
const uiClassic = $('uiClassic'), uiDark = $('uiDark');
const zoomControls = $('zoomControls'), zoomIn = $('zoomIn'), zoomOut = $('zoomOut'), zoomReset = $('zoomReset'), zoomLevel = $('zoomLevel');
const citySearchEl = $('citySearch'), regionFilter = $('regionFilter'), sortOrder = $('sortOrder');
const cityListEl = $('cityList'), cityCountEl = $('cityCount');

// Region mapping
const REGIONS = {
  'North America': ['USA', 'United States', 'Canada', 'Mexico'],
  'South America': ['Brazil', 'Argentina', 'Colombia', 'Chile', 'Peru', 'Venezuela', 'Ecuador', 'Uruguay'],
  'Europe': ['UK', 'United Kingdom', 'France', 'Germany', 'Italy', 'Spain', 'Netherlands', 'Belgium', 'Switzerland', 'Austria', 'Portugal', 'Sweden', 'Norway', 'Denmark', 'Finland', 'Poland', 'Czech Republic', 'Greece', 'Ireland', 'Hungary', 'Romania'],
  'Asia': ['Japan', 'China', 'India', 'South Korea', 'Thailand', 'Vietnam', 'Singapore', 'Malaysia', 'Indonesia', 'Philippines', 'Taiwan', 'Hong Kong', 'UAE', 'Saudi Arabia', 'Israel', 'Turkey', 'Qatar', 'Pakistan', 'Bangladesh'],
  'Africa': ['South Africa', 'Egypt', 'Nigeria', 'Kenya', 'Morocco', 'Ethiopia', 'Ghana', 'Tanzania'],
  'Oceania': ['Australia', 'New Zealand']
};

function getRegion(country) {
  for (const [region, countries] of Object.entries(REGIONS)) {
    if (countries.some(c => country.includes(c) || c.includes(country))) return region;
  }
  return 'Other';
}

// === CITY LIST ===
function renderCityList() {
  if (!CITIES) return;
  const searchTerm = citySearchEl.value.toLowerCase();
  const region = regionFilter.value;
  const sort = sortOrder.value;
  
  let cities = Object.values(CITIES);
  if (searchTerm) cities = cities.filter(c => c.name.toLowerCase().includes(searchTerm) || c.country.toLowerCase().includes(searchTerm));
  if (region) cities = cities.filter(c => getRegion(c.country) === region);
  
  if (sort === 'name') cities.sort((a, b) => a.name.localeCompare(b.name));
  else if (sort === 'name-desc') cities.sort((a, b) => b.name.localeCompare(a.name));
  else if (sort === 'country') cities.sort((a, b) => a.country.localeCompare(b.country) || a.name.localeCompare(b.name));
  
  cityCountEl.textContent = `${cities.length} cities`;
  cityListEl.innerHTML = cities.map(c => `
    <div class="city-item" data-key="${c.name.toLowerCase().replace(/\s+/g, '-')}">
      <div class="name">${c.name}</div>
      <div class="country">${c.country}</div>
    </div>
  `).join('');
  
  cityListEl.querySelectorAll('.city-item').forEach(item => item.onclick = () => selectCity(item.dataset.key));
  if (currentCity) {
    const active = cityListEl.querySelector(`[data-key="${currentCity}"]`);
    if (active) active.classList.add('active');
  }
}

function selectCity(key) {
  const city = CITIES[key];
  if (!city) return;
  
  currentCity = key;
  place = { lat: city.lat, lon: city.lon, osm_type: 'relation', osm_id: city.osm_id, name: city.name, address: { city: city.name, country: city.country } };
  selectedEl.textContent = `${city.name}, ${city.country}`;
  selectedEl.dataset.city = city.name;
  selectedEl.dataset.country = city.country;
  
  cityListEl.querySelectorAll('.city-item').forEach(el => el.classList.remove('active'));
  const active = cityListEl.querySelector(`[data-key="${key}"]`);
  if (active) active.classList.add('active');
  
  genBtn.click();
}

citySearchEl.oninput = renderCityList;
regionFilter.onchange = renderCityList;
sortOrder.onchange = renderCityList;

// === UI THEME ===
uiClassic.onclick = () => { document.body.dataset.ui = 'classic'; uiClassic.classList.add('active'); uiDark.classList.remove('active'); localStorage.setItem('ui', 'classic'); };
uiDark.onclick = () => { document.body.dataset.ui = 'dark'; uiDark.classList.add('active'); uiClassic.classList.remove('active'); localStorage.setItem('ui', 'dark'); };
if (localStorage.getItem('ui') === 'classic') uiClassic.click();

// === INIT THEME DROPDOWNS ===
Object.entries(THEMES).forEach(([k, t]) => {
  const opt = document.createElement('option');
  opt.value = k; opt.textContent = `${t.name} — ${t.desc}`;
  themeEl.appendChild(opt);
  batchTheme.appendChild(opt.cloneNode(true));
});
themeEl.onchange = () => { if (data) render(canvas, themeEl.value, true); };

// === UTILITIES ===
function status(msg, err, loading) {
  statusEl.innerHTML = (loading ? '<span class="spinner"></span>' : '') + msg;
  statusEl.className = 'status-bar' + (err ? ' error' : '') + (loading ? ' loading' : '');
}

function setProgress(pct) {
  if (pct === null) { progressEl.classList.remove('active'); return; }
  progressEl.classList.add('active');
  progressBar.style.width = pct + '%';
}

function getSize() {
  const sizeVal = document.querySelector('input[name="size"]:checked').value;
  const orientVal = document.querySelector('input[name="orient"]:checked').value;
  const [w, h] = SIZES[sizeVal][orientVal];
  return { w, h, orient: orientVal, label: sizeVal };
}
</script>
<script>
// === FETCH DATA ===
async function fetchWithRetry(url, options, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      const res = await fetch(url, options);
      if (res.ok) return res;
      if (res.status === 429 || res.status >= 500) { await new Promise(r => setTimeout(r, (i + 1) * 2000)); continue; }
      throw new Error(`HTTP ${res.status}`);
    } catch (e) { if (i === retries - 1) throw e; await new Promise(r => setTimeout(r, (i + 1) * 2000)); }
  }
}

async function fetchData(areaId, lat, lon, radius, onProgress) {
  const types = ROAD_TYPES.join('|');
  const useArea = !!areaId;
  const streetQ = useArea
    ? `[out:json][timeout:180];area(${areaId})->.a;way(area.a)["highway"~"^(${types})$"];out geom;`
    : `[out:json][timeout:180];way["highway"~"^(${types})$"](around:${radius},${lat},${lon});out geom;`;
  
  status('Fetching street data...', false, true);
  onProgress?.(20);
  const streetRes = await fetchWithRetry('https://overpass-api.de/api/interpreter', { method: 'POST', body: streetQ });
  onProgress?.(50);
  const streets = await streetRes.json();
  onProgress?.(60);
  
  let water = { elements: [] };
  if (waterEl.checked) {
    status('Fetching water bodies...', false, true);
    const waterQ = useArea
      ? `[out:json][timeout:90];area(${areaId})->.a;(way(area.a)["natural"="water"];way(area.a)["waterway"~"river|canal|stream"];relation(area.a)["natural"="water"];);out geom;`
      : `[out:json][timeout:90];(way["natural"="water"](around:${radius},${lat},${lon});way["waterway"~"river|canal|stream"](around:${radius},${lat},${lon}););out geom;`;
    try {
      onProgress?.(70);
      const waterRes = await fetchWithRetry('https://overpass-api.de/api/interpreter', { method: 'POST', body: waterQ });
      water = await waterRes.json();
      onProgress?.(85);
    } catch (e) { console.warn('Water fetch failed', e); }
  }
  onProgress?.(90);
  return { streets, water };
}

function calcBounds(streets, water) {
  let minLat = Infinity, maxLat = -Infinity, minLon = Infinity, maxLon = -Infinity;
  const process = els => els.forEach(el => {
    (el.geometry || []).forEach(p => {
      minLat = Math.min(minLat, p.lat); maxLat = Math.max(maxLat, p.lat);
      minLon = Math.min(minLon, p.lon); maxLon = Math.max(maxLon, p.lon);
    });
  });
  process(streets.elements || []);
  process(water.elements || []);
  const pad = 0.05;
  return { minLat: minLat - (maxLat-minLat)*pad, maxLat: maxLat + (maxLat-minLat)*pad, minLon: minLon - (maxLon-minLon)*pad, maxLon: maxLon + (maxLon-minLon)*pad };
}

function getDisplayNames() {
  const city = customCityEl.value.trim() || data?.city || '';
  const country = customCountryEl.value.trim() || data?.country || '';
  return { city, country };
}

// === RENDER ===
function render(cvs, themeKey, isPreview, scaleOverride, sizeOverride) {
  const size = sizeOverride || getSize();
  const { w: fullW, h: fullH, orient } = size;
  const theme = THEMES[themeKey];
  const scale = scaleOverride || (isPreview ? 0.35 : 1);
  const roadWeight = parseFloat(roadWeightEl?.value || 1);
  const font = fontStyleEl?.value || 'system-ui, sans-serif';
  const showCoords = showCoordsEl?.checked !== false;
  const { city, country } = getDisplayNames();
  
  const w = Math.round(fullW * scale), h = Math.round(fullH * scale);
  cvs.width = w; cvs.height = h;
  const ctx = cvs.getContext('2d');
  
  if (isPreview && (zoom !== 1 || panX !== 0 || panY !== 0)) {
    ctx.translate(w/2 + panX, h/2 + panY);
    ctx.scale(zoom, zoom);
    ctx.translate(-w/2, -h/2);
  }
  
  ctx.fillStyle = theme.bg;
  ctx.fillRect(-w, -h, w*3, h*3);
  
  const margin = Math.min(w, h) * 0.05;
  const isLandscape = orient === 'landscape';
  const mapW = w - margin * 2;
  const mapH = isLandscape ? h * 0.68 : h * 0.72;
  const mapTop = margin;
  
  const b = data.bounds;
  const dataAspect = (b.maxLon - b.minLon) / (b.maxLat - b.minLat);
  const mapAspect = mapW / mapH;
  const adj = { ...b };
  
  if (dataAspect > mapAspect) {
    const latC = (b.minLat + b.maxLat) / 2, range = (b.maxLon - b.minLon) / mapAspect;
    adj.minLat = latC - range / 2; adj.maxLat = latC + range / 2;
  } else {
    const lonC = (b.minLon + b.maxLon) / 2, range = (b.maxLat - b.minLat) * mapAspect;
    adj.minLon = lonC - range / 2; adj.maxLon = lonC + range / 2;
  }
  
  const proj = (lat, lon) => [
    margin + ((lon - adj.minLon) / (adj.maxLon - adj.minLon)) * mapW,
    mapTop + ((adj.maxLat - lat) / (adj.maxLat - adj.minLat)) * mapH
  ];
  
  // Water
  if (waterEl.checked && data.water?.elements) {
    ctx.fillStyle = theme.water;
    ctx.strokeStyle = theme.water;
    ctx.lineWidth = 1.5 * scale * roadWeight;
    data.water.elements.forEach(el => {
      if (!el.geometry) return;
      ctx.beginPath();
      el.geometry.forEach((p, i) => { const [x, y] = proj(p.lat, p.lon); i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y); });
      const g = el.geometry;
      (g[0].lat === g[g.length-1].lat && g[0].lon === g[g.length-1].lon) ? ctx.fill() : ctx.stroke();
    });
  }
  
  // Roads
  const groups = { motorway: [], primary: [], secondary: [], tertiary: [], residential: [] };
  (data.streets.elements || []).forEach(el => {
    if (el.type !== 'way' || !el.geometry) return;
    const hw = el.tags?.highway?.replace('_link', '') || '';
    if (hw === 'motorway' || hw === 'trunk') groups.motorway.push(el);
    else if (hw === 'primary') groups.primary.push(el);
    else if (hw === 'secondary') groups.secondary.push(el);
    else if (hw === 'tertiary') groups.tertiary.push(el);
    else groups.residential.push(el);
  });
  
  const order = ['residential', 'tertiary', 'secondary', 'primary', 'motorway'];
  order.forEach((grp, i) => {
    const roads = groups[grp];
    if (!roads.length) return;
    ctx.strokeStyle = theme.roads[4 - i];
    ctx.lineWidth = BASE_WIDTHS[4 - i] * scale * roadWeight * (isPreview ? 1.3 : 1);
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    roads.forEach(r => {
      ctx.beginPath();
      r.geometry.forEach((p, j) => { const [x, y] = proj(p.lat, p.lon); j === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y); });
      ctx.stroke();
    });
  });
  
  if (isPreview && (zoom !== 1 || panX !== 0 || panY !== 0)) ctx.setTransform(1, 0, 0, 1, 0, 0);
  
  const expandHex = (hex) => hex.length === 4 ? '#' + hex[1] + hex[1] + hex[2] + hex[2] + hex[3] + hex[3] : hex;
  const bgColor = expandHex(theme.bg);
  
  // Fades
  if (!isPreview || zoom === 1) {
    const fadeH = h * 0.08;
    let grad = ctx.createLinearGradient(0, 0, 0, fadeH);
    grad.addColorStop(0, bgColor); grad.addColorStop(1, bgColor + '00');
    ctx.fillStyle = grad; ctx.fillRect(0, 0, w, fadeH);
    
    grad = ctx.createLinearGradient(0, mapTop + mapH - fadeH, 0, mapTop + mapH + fadeH * 0.5);
    grad.addColorStop(0, bgColor + '00'); grad.addColorStop(1, bgColor);
    ctx.fillStyle = grad; ctx.fillRect(0, mapTop + mapH - fadeH, w, fadeH * 1.5);
  }
  
  // Text
  const textY = mapTop + mapH + margin * (isLandscape ? 0.6 : 0.8);
  ctx.textAlign = 'center';
  
  const citySize = Math.round((isLandscape ? 40 : 48) * scale);
  ctx.font = `300 ${citySize}px ${font}`;
  ctx.fillStyle = theme.text;
  const cityUpper = city.toUpperCase();
  const spacing = 10 * scale;
  let tw = 0;
  for (const c of cityUpper) tw += ctx.measureText(c).width + spacing;
  tw -= spacing;
  let x = (w - tw) / 2;
  for (const c of cityUpper) { ctx.fillText(c, x + ctx.measureText(c).width / 2, textY); x += ctx.measureText(c).width + spacing; }
  
  const lineY = textY + citySize * 0.35;
  ctx.strokeStyle = theme.text + '40'; ctx.lineWidth = scale;
  ctx.beginPath(); ctx.moveTo(w/2 - 30*scale, lineY); ctx.lineTo(w/2 + 30*scale, lineY); ctx.stroke();
  
  const countrySize = Math.round(18 * scale);
  ctx.font = `400 ${countrySize}px ${font}`;
  ctx.fillStyle = theme.text + 'cc';
  ctx.fillText(country.toUpperCase(), w/2, lineY + countrySize * 1.4);
  
  if (showCoords) {
    const coordSize = Math.round(12 * scale);
    ctx.font = `300 ${coordSize}px ${font}`;
    ctx.fillStyle = theme.text + '88';
    const lat = data.lat, lon = data.lon;
    const coords = `${Math.abs(lat).toFixed(4)}°${lat >= 0 ? 'N' : 'S'}, ${Math.abs(lon).toFixed(4)}°${lon >= 0 ? 'E' : 'W'}`;
    ctx.fillText(coords, w/2, lineY + countrySize * 1.4 + coordSize * 1.6);
  }
}
</script>
<script>
// === GENERATE ===
genBtn.onclick = async () => {
  if (!place) { status('Select a city first'); return; }
  
  genBtn.disabled = true;
  dlBtn.disabled = true;
  dlSvgBtn.disabled = true;
  compareBtn.disabled = true;
  zoom = 1; panX = 0; panY = 0;
  
  try {
    status('Resolving city boundary...', false, true);
    setProgress(5);
    
    let areaId = null;
    if (place.osm_type === 'relation' && place.osm_id) {
      areaId = 3600000000 + place.osm_id;
    }
    
    const radius = parseInt(radiusEl?.value || 10000);
    const result = await fetchData(areaId, place.lat, place.lon, radius, setProgress);
    
    const bounds = calcBounds(result.streets, result.water);
    data = {
      streets: result.streets,
      water: result.water,
      bounds,
      lat: place.lat,
      lon: place.lon,
      city: selectedEl.dataset.city || place.name || '',
      country: selectedEl.dataset.country || place.address?.country || ''
    };
    
    setProgress(95);
    render(canvas, themeEl.value, true);
    setProgress(100);
    
    const roadCount = result.streets.elements?.length || 0;
    const waterCount = result.water.elements?.length || 0;
    status(`${roadCount.toLocaleString()} roads${waterCount ? `, ${waterCount.toLocaleString()} water features` : ''}`);
    
    dlBtn.disabled = false;
    dlSvgBtn.disabled = false;
    compareBtn.disabled = false;
    zoomControls.classList.add('visible');
    
  } catch (e) {
    console.error(e);
    status('Error: ' + e.message, true);
  } finally {
    genBtn.disabled = false;
    setTimeout(() => setProgress(null), 500);
  }
};

// === DOWNLOAD ===
dlBtn.onclick = () => {
  if (!data) return;
  status('Generating full resolution...', false, true);
  const { city } = getDisplayNames();
  const size = getSize();
  
  offscreen.width = size.w;
  offscreen.height = size.h;
  render(offscreen, themeEl.value, false);
  
  offscreen.toBlob(blob => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${city.toLowerCase().replace(/\s+/g, '-')}-${size.label}-${size.orient}.png`;
    a.click();
    status('Downloaded!');
  }, 'image/png');
};

dlSvgBtn.onclick = () => {
  if (!data) return;
  status('Generating SVG...', false, true);
  // SVG generation simplified for now
  status('SVG export coming soon');
};

// === ZOOM ===
zoomIn.onclick = () => { zoom = Math.min(zoom * 1.2, 5); zoomLevel.textContent = Math.round(zoom * 100) + '%'; render(canvas, themeEl.value, true); };
zoomOut.onclick = () => { zoom = Math.max(zoom / 1.2, 0.5); zoomLevel.textContent = Math.round(zoom * 100) + '%'; render(canvas, themeEl.value, true); };
zoomReset.onclick = () => { zoom = 1; panX = 0; panY = 0; zoomLevel.textContent = '100%'; render(canvas, themeEl.value, true); };

let isPanning = false, lastX, lastY;
canvas.onmousedown = e => { isPanning = true; lastX = e.clientX; lastY = e.clientY; canvas.style.cursor = 'grabbing'; };
document.onmousemove = e => { if (!isPanning) return; panX += e.clientX - lastX; panY += e.clientY - lastY; lastX = e.clientX; lastY = e.clientY; if (data) render(canvas, themeEl.value, true); };
document.onmouseup = () => { isPanning = false; canvas.style.cursor = 'grab'; };
canvas.onwheel = e => { e.preventDefault(); const d = e.deltaY > 0 ? 0.9 : 1.1; zoom = Math.min(Math.max(zoom * d, 0.5), 5); zoomLevel.textContent = Math.round(zoom * 100) + '%'; if (data) render(canvas, themeEl.value, true); };

// === COMPARE MODAL ===
compareBtn.onclick = () => {
  if (!data) return;
  modal.classList.add('open');
  themeGrid.innerHTML = '';
  
  Object.entries(THEMES).forEach(([key, theme]) => {
    const card = document.createElement('div');
    card.className = 'theme-card';
    const cvs = document.createElement('canvas');
    render(cvs, key, true, 0.2);
    card.appendChild(cvs);
    const info = document.createElement('div');
    info.className = 'theme-card-info';
    info.innerHTML = `<span class="theme-card-name">${theme.name}</span><button class="btn btn-primary" style="padding:6px 12px; font-size:10px;">Select</button>`;
    info.querySelector('button').onclick = () => { themeEl.value = key; render(canvas, key, true); modal.classList.remove('open'); };
    card.appendChild(info);
    themeGrid.appendChild(card);
  });
};
modalClose.onclick = () => modal.classList.remove('open');

// === BATCH MODAL ===
batchBtn.onclick = () => batchModal.classList.add('open');
batchClose.onclick = () => batchModal.classList.remove('open');

batchStart.onclick = async () => {
  const lines = batchInput.value.split('\n').map(l => l.trim()).filter(l => l && l.includes(','));
  if (!lines.length) { batchStatus.textContent = 'No valid cities'; return; }
  
  batchStart.disabled = true;
  batchLog.innerHTML = '';
  batchProgress.classList.add('active');
  const results = [];
  
  for (let i = 0; i < lines.length; i++) {
    const [cityName, countryName] = lines[i].split(',').map(s => s.trim());
    batchStatus.textContent = `Processing ${i + 1}/${lines.length}: ${cityName}`;
    batchProgressBar.style.width = ((i + 1) / lines.length * 100) + '%';
    
    try {
      // Geocode
      const geoRes = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(cityName + ', ' + countryName)}&limit=1`);
      const geoData = await geoRes.json();
      if (!geoData.features?.length) throw new Error('City not found');
      
      const feature = geoData.features[0];
      const [lon, lat] = feature.geometry.coordinates;
      const osmId = feature.properties.osm_id;
      const osmType = feature.properties.osm_type;
      
      let areaId = null;
      if (osmType === 'R' && osmId) areaId = 3600000000 + osmId;
      
      const result = await fetchData(areaId, lat, lon, 10000, null);
      const bounds = calcBounds(result.streets, result.water);
      
      const tempData = { streets: result.streets, water: result.water, bounds, lat, lon, city: cityName, country: countryName };
      const oldData = data;
      data = tempData;
      
      const [sizeVal, orientVal] = batchSize.value.split('-');
      const size = { w: SIZES[sizeVal][orientVal][0], h: SIZES[sizeVal][orientVal][1], orient: orientVal, label: sizeVal };
      
      offscreen.width = size.w;
      offscreen.height = size.h;
      render(offscreen, batchTheme.value, false, 1, size);
      
      const blob = await new Promise(r => offscreen.toBlob(r, 'image/png'));
      results.push({ name: `${cityName.toLowerCase().replace(/\s+/g, '-')}.png`, blob });
      batchLog.innerHTML += `<div style="color:#4a9eff;">✓ ${cityName}</div>`;
      
      data = oldData;
    } catch (e) {
      batchLog.innerHTML += `<div style="color:#e55;">✗ ${cityName}: ${e.message}</div>`;
    }
    
    if (i < lines.length - 1) await new Promise(r => setTimeout(r, 2000));
  }
  
  // Download ZIP
  if (results.length) {
    batchStatus.textContent = 'Creating ZIP...';
    const { default: JSZip } = await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm');
    const zip = new JSZip();
    results.forEach(r => zip.file(r.name, r.blob));
    const content = await zip.generateAsync({ type: 'blob' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(content);
    a.download = 'map-posters.zip';
    a.click();
  }
  
  batchStatus.textContent = `Done! ${results.length}/${lines.length} generated`;
  batchStart.disabled = false;
  batchProgress.classList.remove('active');
};

// === KEYBOARD ===
document.onkeydown = e => { if (e.key === 'Escape') { modal.classList.remove('open'); batchModal.classList.remove('open'); } };

// === OPTION CHANGES ===
document.querySelectorAll('[name="size"], [name="orient"]').forEach(el => { el.onchange = () => { if (data) render(canvas, themeEl.value, true); }; });

// === INIT ===
window.addEventListener('load', () => {
  renderCityList();
  setTimeout(() => selectCity('austin'), 100);
});
</script>
</body>
</html>
